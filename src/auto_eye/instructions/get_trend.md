Ниже — ТЗ на **определение и хранение тренда** в Speculator по твоему текущему правилу: **тренд задаётся H1 “неэффективностями” (FVG/SNR)**, а все результаты и взаимодействия лежат в `Exchange`.

---

# ТЗ: Определение и хранение тренда по H1 FVG/SNR (Speculator)

## 1) Цель

Реализовать механизм, который для **каждого актива (symbol)**:

1. вычисляет **направление тренда** на основании событий на **таймфрейме H1**:

* тренд **восходящий**, если на H1 сформирована **положительная неэффективность**: `+H1 FVG` или `+H1 SNR`
* тренд **нисходящий**, если на H1 сформирована **отрицательная неэффективность**: `-H1 FVG` или `-H1 SNR`

2. сохраняет и актуализирует тренд в `Exchange`, чтобы:

* он был доступен для генерации сценариев,
* можно было дебажить (“почему сейчас bullish?”),
* не было “дребезга” и дублей.

---

## 2) Термины и определения

### 2.1. Источник данных

* `Exchange/State/<SYMBOL>.json`
* используется `timeframes.H1.elements.fvg[]`, `timeframes.H1.elements.snr[]`

### 2.2. Сигнал тренда от FVG

Определение знака:

* `+H1 FVG` ⇔ `fvg.direction == "bullish"`
* `-H1 FVG` ⇔ `fvg.direction == "bearish"`

Учитываются только FVG со статусом:

* `status in {"active","touched"}` (MVP)

### 2.3. Сигнал тренда от SNR

Определение знака:

* `+H1 SNR` ⇔ зона поддержки / пробой вверх
  (любой из эквивалентных критериев, выбрать один и зафиксировать):

  * `snr.role == "support"` **или**
  * `snr.break_type == "break_up_close"`
* `-H1 SNR` ⇔ зона сопротивления / пробой вниз:

  * `snr.role == "resistance"` **или**
  * `snr.break_type == "break_down_close"`

Учитываются только SNR со статусом:

* `status in {"active","retested"}` (MVP)

> Примечание: `invalidated` не участвует в тренде.

---

## 3) Логика вычисления тренда (MVP)

### 3.1. Выбор “последнего сигнала”

Для H1 берётся **самый свежий валидный сигнал** из множества:

* активных/актуальных FVG (bullish/bearish)
* активных/актуальных SNR (support/resistance)

**Временная метка сигнала:**

* для FVG: `formation_time_utc`
* для SNR: `break_time_utc` (момент закрепления/переворота)

Выбирается сигнал с максимальным `signal_time_utc`.

### 3.2. Маппинг сигнала в тренд

* если последний сигнал `+H1 FVG` или `+H1 SNR` → `trend = "bullish"`
* если последний сигнал `-H1 FVG` или `-H1 SNR` → `trend = "bearish"`
* если валидных сигналов нет → `trend = "neutral"` (или `unknown`, выбрать и зафиксировать)

### 3.3. Разрешение конфликтов (когда есть и + и -)

Так как мы берём **последний по времени**, конфликт решается автоматически:

* кто “новее” — тот и задаёт тренд.

---

## 4) Хранение тренда в Exchange

## 4.1. Путь

* `Exchange/Trends/<SYMBOL>.json`

## 4.2. Формат файла

```json id="4dyv6o"
{
  "schema_version": "1.0.0",
  "symbol": "SPX500",
  "updated_at_utc": "2026-02-27T12:00:00Z",

  "trend": {
    "timeframe": "H1",
    "direction": "bullish|bearish|neutral",
    "determined_at_utc": "2026-02-27T12:00:00Z",

    "source_signal": {
      "type": "fvg|snr",
      "polarity": "positive|negative",
      "signal_time_utc": "2026-02-27T11:00:00Z",
      "element_id": "..."
    }
  },

  "history": [
    {
      "changed_at_utc": "2026-02-27T11:00:00Z",
      "direction": "bearish",
      "source_signal": { "type": "snr", "polarity": "negative", "signal_time_utc": "...", "element_id": "..." }
    }
  ]
}
```

### Требования

* `trend.direction` всегда одно из фиксированных значений.
* `source_signal.element_id` — ссылка на элемент в `State` для трассировки.
* `history` (опционально) хранит последние N смен тренда (например N=50).

### Атомарная запись

Запись через:

* `<SYMBOL>.json.tmp` → rename в `<SYMBOL>.json`

---

## 5) Триггеры пересчёта

### 5.1. Когда пересчитывать

Пересчёт тренда для символа выполняется, если изменился `State/<SYMBOL>.json`, и при этом:

* изменился набор `H1.elements.fvg` (добавление/изменение статуса)
* или изменился набор `H1.elements.snr` (добавление/изменение статуса)

### 5.2. Частота

MVP: пересчитывать при каждом обновлении H1 (раз в час) **или** при любой записи State (если проще).

---

## 6) Критерии обновления файла Trends

`Exchange/Trends/<SYMBOL>.json` перезаписывается только если:

* изменилась `trend.direction`, **или**
* изменился `source_signal.element_id`, **или**
* изменился `source_signal.signal_time_utc`.

---

## 7) Acceptance Criteria (готовность)

1. Для каждого актива создаётся `Exchange/Trends/<SYMBOL>.json`.
2. При появлении нового H1 bullish FVG или support SNR тренд становится `bullish`.
3. При появлении нового H1 bearish FVG или resistance SNR тренд становится `bearish`.
4. При отсутствии валидных H1 сигналов тренд `neutral`.
5. В файле тренда есть `source_signal`, позволяющий точно объяснить “почему”.